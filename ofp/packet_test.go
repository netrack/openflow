package ofp

import (
	"encoding/gob"
	"testing"

	"github.com/netrack/openflow/internal/encodingtest"
)

func TestPacketIn(t *testing.T) {
	tests := []encodingtest.MU{
		{&PacketIn{
			Buffer: NoBuffer,
			Length: 0x38,
			Reason: PacketInReasonAction,
			Table:  Table(2),
			Cookie: 0xdeadbeef,
			Match: Match{MatchTypeXM, []XM{{
				Class: XMClassOpenflowBasic,
				Type:  XMTypeInPort,
				Value: XMValue{0x00, 0x00, 0x00, 0x03},
			}}},
			Data: []byte{
				0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
				0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
				0x08, 0x06,
			},
		}, []byte{
			0xff, 0xff, 0xff, 0xff, // Buffer identifier.
			0x00, 0x38, // Total frame length.
			0x01, // Packet-in submission reason.
			0x02, // Table identifier.
			0x00, 0x00, 0x00, 0x00,
			0xde, 0xad, 0xbe, 0xef, // Cookie.

			0x00, 0x01, // Match type.
			0x00, 0x0c, // Match length.

			// Match.
			0x80, 0x00, // OpenFlow basic.
			0x00,                   // Match field + Mask flag.
			0x04,                   // Match field length.
			0x00, 0x00, 0x00, 0x03, // Match field value.
			0x00, 0x00, 0x00, 0x00, // 4-byte padding.
			0x00, 0x00, // 2-byte padding.

			// Original ethernet frame.
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // Destination MAC.
			0x11, 0x11, 0x11, 0x11, 0x11, 0x11, // Source MAC.
			0x08, 0x06, // Ether-Type
		}},
	}

	encodingtest.RunMU(t, tests)
}

func TestPacketOut(t *testing.T) {
	tests := []encodingtest.MU{
		// Test Packet-Out without data (buffer_id required).
		{&PacketOut{
			Buffer:  0x01,
			InPort:  PortController,
			Actions: Actions{&ActionGroup{Group: GroupAll}},
		}, []byte{
			0x00, 0x00, 0x00, 0x01, // Buffer identifier.
			0xff, 0xff, 0xff, 0xfd, // Port number.
			0x00, 0x08, // Actions list length in bytes.
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 6-byte padding.

			// Actions.
			0x00, 0x16, // Action group.
			0x00, 0x08,
			0xff, 0xff, 0xff, 0xfc,
		}},
		// Test Packet-Out with data (no buffer_id).
		{&PacketOut{
			Buffer:  NoBuffer,
			InPort:  PortController,
			Actions: Actions{&ActionOutput{Port: PortNo(1)}},
			Data: []byte{
				0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
				0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
				0x08, 0x06,
			},
		}, []byte{
			0xff, 0xff, 0xff, 0xff, // Buffer identifier (OFP_NO_BUFFER).
			0xff, 0xff, 0xff, 0xfd, // Port number (OFPP_CONTROLLER).
			0x00, 0x10, // Actions list length in bytes.
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 6-byte padding.

			// Actions.
			0x00, 0x00, // Type output.
			0x00, 0x10, // Length.
			0x00, 0x00, 0x00, 0x01, // Port.
			0x00, 0x00, // Max length.
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 6-byte padding.

			// Data with the ethernet frame.
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // Destination MAC.
			0x11, 0x11, 0x11, 0x11, 0x11, 0x11, // Source MAC.
			0x08, 0x06, // Ether-Type
		}},
	}

	gob.Register(ActionGroup{})
	gob.Register(ActionOutput{})
	encodingtest.RunMU(t, tests)
}
